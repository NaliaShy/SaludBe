<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SaludMental ‚Äî Nivel DIOS v5 (Unificado)</title>
<style>
:root{
  --brand:#458a1d; --bg:#071426; --panel:#0b2312; --bot-bg:#eef8ea; --text-dark:#07220a;
  --drawer-w:380px;
}
*{box-sizing:border-box;font-family:Inter, Arial, sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#041022,#071426);color:#fff}

/* TOP BAR (kept minimal) */
.topbar{position:fixed;left:0;right:0;top:0;height:64px;background:linear-gradient(90deg,var(--brand),#2f6e14);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:8000;box-shadow:0 6px 20px rgba(0,0,0,0.35)}
.brand{display:flex;align-items:center;gap:12px;color:white}
.brand img{width:40px;height:40px;border-radius:8px;border:2px solid rgba(255,255,255,0.12);object-fit:cover}
.brand .title{font-weight:700;font-size:18px}
.brand .sub{font-size:12px;opacity:.95}

/* Floating oval button (style 3) bottom-right */
.fab-oval{
  position:fixed; right:18px; bottom:18px; z-index:9000;
  width:140px; height:52px; border-radius:28px; display:flex;align-items:center;gap:12px;
  padding:8px 14px; cursor:pointer; box-shadow:0 18px 50px rgba(0,0,0,.45);
  background:linear-gradient(90deg,var(--brand), #2f6e14); color:white; font-weight:700;
}
.fab-oval img{ width:36px; height:36px; border-radius:8px; object-fit:cover; border:2px solid rgba(255,255,255,0.12); }

/* App area */
.app{display:flex;flex-direction:column;align-items:center;padding:88px 24px 24px 24px;min-height:100vh}
.chat-card{width:100%;max-width:980px;background:linear-gradient(180deg,#071a0f,#072116);border-radius:14px;box-shadow:0 30px 100px rgba(0,0,0,0.6);overflow:hidden;display:flex;flex-direction:column;min-height:560px}

/* header inside card */
.header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:transparent;color:white}
.header .title{font-size:16px;font-weight:700}
.header .sub{font-size:12px;opacity:.9}

/* messages layout */
.main-body{display:flex;flex-direction:row;gap:0}
.messages-wrap{flex:1;padding:12px;display:flex;flex-direction:column;height:520px}
.messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(180deg,#081a12,#071726);border-radius:8px;display:flex;flex-direction:column;gap:8px}
.bubble{display:inline-block;padding:10px 14px;border-radius:12px;max-width:78%;line-height:1.4;animation:pop .18s forwards;opacity:0;transform:translateY(6px)}
@keyframes pop{to{opacity:1;transform:none}}
.bubble.user{background:var(--brand);color:white;margin-left:auto;border-bottom-right-radius:6px}
.bubble.bot{background:var(--bot-bg);color:var(--text-dark);margin-right:auto;border-bottom-left-radius:6px}

/* controls */
.controls{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
.controls input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:white;outline:none}
.btn{background:var(--brand);color:white;padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
.small{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:white;border:1px solid rgba(255,255,255,0.03);cursor:pointer}

/* drawer overlay (right) */
.drawer-overlay{position:fixed;top:64px;right:0;bottom:0;width:var(--drawer-w);background:linear-gradient(180deg,#072017,#062012);box-shadow:-40px 0 80px rgba(0,0,0,0.6);transform:translateX(110%);transition:transform .28s ease;z-index:8500;display:flex;flex-direction:column;padding:16px;gap:12px}
.drawer-overlay.open{transform:translateX(0)}
.avatar-frame{width:84px;height:84px;border-radius:12px;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
.avatar-frame img{width:100%;height:100%;object-fit:cover}
.drawer-head{color:white;font-weight:700;text-align:center}
.drawer-sub{color:rgba(255,255,255,0.75);font-size:13px;text-align:center}
.resource-box{background:#052615;padding:10px;border-radius:10px;color:#dfffe0;font-size:13px;text-align:left;overflow:auto;max-height:260px}

/* coste√±o badge */
.costeno-badge{background:#ffdd57;color:#07220a;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}

/* small screens: drawer becomes full-screen modal */
@media(max-width:820px){
  .drawer-overlay{width:100%;left:0;right:0;top:64px;transform:translateY(-110%);height:calc(100vh - 64px)}
  .drawer-overlay.open{transform:translateY(0)}
  .main-body{flex-direction:column}
  .messages-wrap{height:60vh}
}

/* typing indicator */
.typing{display:inline-flex;gap:6px;padding:8px 12px;border-radius:10px;background:#e9f7ea;color:var(--text-dark)}
.link-lite{color:#bfffb7;text-decoration:underline}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="brand">
    <img src="/mnt/data/d5f8f1ba-3052-48ce-836b-9d3db1507244.png" alt="avatar">
    <div>
      <div class="title">SaludMental ‚Äî Asistente</div>
      <div class="sub">Apoyo emocional ‚Ä¢ Respuestas seguras</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="menuBtnTop" class="small" title="Abrir men√∫">‚ò∞ Ajustes</button>
  </div>
</div>

<!-- FAB oval (style 3) bottom-right -->
<div class="fab-oval" id="openFab" title="Abrir Asistente">
  <img src="/mnt/data/d5f8f1ba-3052-48ce-836b-9d3db1507244.png" alt="avatar">
  <div>Hablar</div>
</div>

<!-- App -->
<div class="app">
  <div class="chat-card" role="application" aria-label="Chat de apoyo">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:44px;height:44px;border-radius:10px;overflow:hidden;border:2px solid rgba(255,255,255,0.08)"><img src="/mnt/data/d5f8f1ba-3052-48ce-836b-9d3db1507244.png" style="width:100%;height:100%;object-fit:cover" alt="avatar"></div>
        <div>
          <div class="title">SaludMental ‚Äî Asistente <span id="coste√±oBadge" class="costeno-badge" style="display:none">COSTE√ëO</span></div>
          <div class="sub">Apoyo emocional ‚Ä¢ Respuestas seguras</div>
        </div>
      </div>
    </div>

    <div class="main-body">
      <div class="messages-wrap">
        <div id="messages" class="messages" aria-live="polite"></div>
        <div id="typingArea" style="padding:10px 12px"></div>
        <div class="controls">
          <input id="input" placeholder="Escribe aqu√≠... (Enter para enviar)" autocomplete="off"/>
          <button id="micBtn" class="btn" title="Hablar">üé§</button>
          <button id="voiceToggle" class="small" title="Des/activar voz">üîä</button>
          <button id="sendBtn" class="btn">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer overlay (right) -->
<div id="drawer" class="drawer-overlay" aria-hidden="true">
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
    <div class="avatar-frame"><img id="drawerAvatar" src="/mnt/data/d5f8f1ba-3052-48ce-836b-9d3db1507244.png" alt="avatar"></div>
    <div class="drawer-head">Asistente Salud</div>
    <div class="drawer-sub">Modo DIOS ‚Ä¢ Memoria local</div>
  </div>

  <div style="display:flex;flex-direction:column;gap:8px">
    <button id="exerciseBtn" class="small">Ejercicio Respiraci√≥n</button>
    <button id="contactBtn" class="small">Solicitar contacto</button>
    <div style="font-size:12px;color:rgba(255,255,255,0.7);text-align:center">Si est√°s en riesgo, llama a emergencias.</div>
  </div>

  <div style="display:flex;flex-direction:column;gap:8px">
    <div style="font-weight:700">Ajustes del widget</div>
    <label style="font-size:13px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="costenoToggle"> Activar modo coste√±o</label>
    <label style="font-size:13px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="showAvatarToggle" checked> Mostrar avatar al abrir</label>
    <label style="font-size:13px;display:flex;align-items:center;gap:8px"><input type="checkbox" id="autoOpenOnCrisis"> Abrir drawer autom√°ticamente en crisis</label>
  </div>

  <div id="resourceBox" class="resource-box" style="display:none"></div>

  <div style="margin-top:auto;font-size:13px;color:#bfffb7">
    <!-- Developer note: using uploaded file path as requested -->
    <a id="conversationLog" class="link-lite" href="/mnt/data/conversacion_saludmental.json" target="_blank">Descargar log de conversaci√≥n (prueba)</a>
  </div>
</div>

<script>
/* =========================
  Nivel DIOS v5 ‚Äî Unificado
  - FAB oval abajo-derecha (style 3) abre chat
  - Drawer desde la derecha con ajustes y recursos
  - Modo coste√±o, TTS, mic, crisis persistente
  - Env√≠a link recursos 24/7 tras repetici√≥n de riesgo
  - No repite textualmente al usuario
  - Memoria local, export/import/reset (drawer can be extended)
=========================*/

/* ---------- Config ---------- */
const LS_CONV = 'sm_dios_v5_conv';
const LS_CUSTOM = 'sm_dios_v5_custom';
const LS_MARKOV = 'sm_dios_v5_markov';

const RESOURCE_24H_URLS = [
  { label: 'L√≠nea 106 (Colombia) - Atenci√≥n en crisis', url: 'tel:106' },
  { label: 'Emergencias Colombia', url: 'tel:123' },
  { label: 'Recursos internacionales (WHO)', url: 'https://www.who.int/teams/mental-health-and-substance-use' },
];
const PRIMARY_HELP_LINK = 'https://www.opencounseling.com/suicide-hotlines';

const HIGH_RISK_WINDOW_MS = 10 * 60 * 1000; // 10 min
const HIGH_RISK_THRESHOLD = 2; // >=2 messages in window triggers help
let recentHighRiskTimestamps = [];
let sentHelpLinkThisSession = false;

/* ---------- Elements ---------- */
const openFab = document.getElementById('openFab');
const drawer = document.getElementById('drawer');
const menuBtnTop = document.getElementById('menuBtnTop');
const messagesEl = document.getElementById('messages');
const typingArea = document.getElementById('typingArea');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const voiceToggle = document.getElementById('voiceToggle');
const exerciseBtn = document.getElementById('exerciseBtn');
const contactBtn = document.getElementById('contactBtn');
const resourceBox = document.getElementById('resourceBox');
const costenoToggle = document.getElementById('costenoToggle');
const showAvatarToggle = document.getElementById('showAvatarToggle');
const autoOpenOnCrisis = document.getElementById('autoOpenOnCrisis');
const coste√±oBadge = document.getElementById('coste√±oBadge');

/* ---------- Utilities ---------- */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const randomChoice = arr => arr[Math.floor(Math.random()*arr.length)];

/* ---------- Crisis keywords (expanded) ---------- */
const crisisKeywords = [
  'suicid','matarme','me voy a morir','no quiero vivir','suicidio','lastimarme','hacerme da√±o',
  'quitarme','me quiero morir','lanzarme','lanza','cortarme','autolesion','autolesi√≥n'
];

/* ---------- Response banks & KB ---------- */
const safeResponses = {
  empathic: ["Siento que est√°s pasando por un momento dif√≠cil. Estoy aqu√≠ para escucharte.","Gracias por contarme eso. No est√°s solo."],
  coping: ["Respira conmigo: inhala 4s, sostiene 4s, exhala 6s. Repite 3 veces.","Intenta identificar 3 cosas que ves ahora para anclarte."],
  resources: ["Si te sientes en peligro, busca ayuda: llama a emergencias o a una l√≠nea de apoyo local.","¬øQuieres que te ayude a redactar un mensaje para pedir ayuda a un amigo?"]
};
const knowledgeBase = { ansiedad: ["La ansiedad baja con respiraci√≥n y grounding."], depresion: ["Peque√±as rutinas ayudan a recuperar energ√≠a."] };
const variationPool = ["Te entiendo. ¬øQuieres que lo desglosamos?","¬øQuieres intentar un ejercicio breve?","Puedo acompa√±arte mientras lo cuentas."];

const lastReplies = [];
function pickNonRepeating(arr){
  if(!Array.isArray(arr)) arr=[arr];
  let pick = randomChoice(arr);
  let tries = 0;
  while(lastReplies.length>0 && pick === lastReplies[lastReplies.length-1] && tries < 8){
    pick = randomChoice(arr); tries++;
  }
  lastReplies.push(pick); if(lastReplies.length>12) lastReplies.shift(); return pick;
}

/* ---------- State ---------- */
let voiceEnabled = true;
let listening = false;
let recognition = null;
let coste√±oMode = false;
let showAvatarOnOpen = true;
let lastBotMessage = "";
let crisisMode = false; // persistent until cleared by user or safe interactions

/* ---------- Storage helpers ---------- */
function saveConv(conv){ try{ localStorage.setItem(LS_CONV, JSON.stringify(conv)); }catch(e){} }
function loadConv(){ try{ return JSON.parse(localStorage.getItem(LS_CONV)) || []; }catch(e){ return []; } }
function saveCustom(obj){ try{ localStorage.setItem(LS_CUSTOM, JSON.stringify(obj)); }catch(e){} }
function loadCustom(){ try{ return JSON.parse(localStorage.getItem(LS_CUSTOM) || '{}'); }catch(e){ return {}; } }

/* ---------- Markov & TF-IDF (lightweight) ---------- */
function tokenize(s){ return (s||'').toLowerCase().replace(/[^\w√°√©√≠√≥√∫√±\s]/g,' ').split(/\s+/).filter(Boolean); }
function markovTrain(text){ try{ const db = JSON.parse(localStorage.getItem(LS_MARKOV)||'{}'); const words = tokenize(text); for(let i=0;i<words.length-1;i++){ const w=words[i], nx=words[i+1]; db[w]=db[w]||{}; db[w][nx]=(db[w][nx]||0)+1; } localStorage.setItem(LS_MARKOV, JSON.stringify(db)); }catch(e){} }
function markovGenerate(seed=null,len=6){ try{ const db = JSON.parse(localStorage.getItem(LS_MARKOV)||'{}'); const keys = Object.keys(db); if(keys.length===0) return null; let word = seed && db[seed]?seed:randomChoice(keys); const out=[word]; for(let i=0;i<len-1;i++){ const nexts=db[word]; if(!nexts) break; const choices=Object.keys(nexts); let total=0; choices.forEach(c=>total+=nexts[c]); let r=Math.random()*total; let pick=choices[0]; for(const c of choices){ r-=nexts[c]; if(r<=0){ pick=c; break } } out.push(pick); word=pick; } return out.join(' '); }catch(e){ return null; } }
function buildDocs(){ const docs=[]; for(const k in knowledgeBase) docs.push({id:k, text: knowledgeBase[k].join(' ')}); for(const k in safeResponses) docs.push({id:'safe_'+k, text: safeResponses[k].join(' ')}); const custom = loadCustom(); for(const k in custom) docs.push({id:'custom_'+k, text: custom[k]}); return docs; }
function computeTfIdf(docs){ const df={}, tf=[]; docs.forEach(d=>{ const words=tokenize(d.text); const freqs={}; words.forEach(w=>freqs[w]=(freqs[w]||0)+1); tf.push(freqs); const unique=new Set(words); unique.forEach(w=>df[w]=(df[w]||0)+1); }); const N=docs.length||1; const tfidf=tf.map(freqs=>{ const vec={}; for(const w in freqs){ const tfw=freqs[w]; const idf=Math.log(1+N/(df[w]||1)); vec[w]=tfw*idf; } return vec; }); return {docs, tfidf}; }
function cosine(a,b){ let num=0, na=0, nb=0; for(const k in a){ num+= a[k]*(b[k]||0); na+=a[k]*a[k]; } for(const k in b) nb+= b[k]*b[k]; if(na===0||nb===0) return 0; return num/(Math.sqrt(na)*Math.sqrt(nb)); }
function findBestMatch(query, tfObj){ const qTokens=tokenize(query); if(qTokens.length===0) return null; const qfreq={}; qTokens.forEach(w=>qfreq[w]=(qfreq[w]||0)+1); const dfAll={}; tfObj.docs.forEach((d,i)=> Object.keys(tfObj.tfidf[i]).forEach(w=> dfAll[w]=(dfAll[w]||0)+1)); const N=tfObj.docs.length||1; const qvec={}; for(const w in qfreq){ const idf=Math.log(1+N/(dfAll[w]||1)); qvec[w]=qfreq[w]*idf; } let best={score:0, idx:-1}; tfObj.tfidf.forEach((vec,i)=>{ const sc=cosine(vec,qvec); if(sc>best.score) best={score:sc, idx:i}; }); if(best.idx===-1) return null; return {doc: tfObj.docs[best.idx], score: best.score}; }

/* ---------- Intent classifier ---------- */
function classifyIntent(text){
  const t = text.toLowerCase();
  if(/^(hola|buenas|buenos dias|buenas tardes)/.test(t)) return 'saludo';
  if(t.includes('gracias')) return 'agradecimiento';
  if(t.includes('ansiedad')||t.includes('ansioso')||t.includes('nervios')) return 'ansiedad';
  if(t.includes('depres')||t.includes('triste')||t.includes('sin ganas')) return 'depresion';
  if(t.includes('insomnio')||t.includes('no puedo dormir')) return 'insomnio';
  if(t.includes('respira')||t.includes('respiracion')) return 'ejercicio';
  if(crisisKeywords.some(k=>t.includes(k))) return 'crisis';
  return 'conversacion';
}

/* ---------- Coste√±o mode conversion ---------- */
function toCoste√±o(text){
  // lightweight replacements and some coste√±o endings
  let out = text;
  const replacements = [
    [/¬øQuieres/gi, '¬øQuer√©s'],
    [/por favor/gi, 'por fa'],
    [/Estoy contigo/gi, "Toy contigo, parcero"],
    [/No est√°s solo/gi, "No t√° solito"],
    [/Gracias/gi, "Gracias mi hermano"],
    [/Hola/gi, "Qu√© hubo, mi llave"],
    [/¬øC√≥mo te sientes/gi, "¬øC√≥mo te sientes, mi llave?"],
    [/Siento que/gi, "Me da pena que"],
    [/respira/gi, "respir√†"]
  ];
  replacements.forEach(([a,b]) => { out = out.replace(a,b); });
  // add some local phrase randomly
  if(Math.random() < 0.25) out += " ¬øQuer√©s que lo hablemos a tu modo, parcero?";
  return out;
}

/* ---------- Response generator ---------- */
function responseByIntent(intent, text, ctx){
  const base = (()=>{
    switch(intent){
      case 'saludo': return pickNonRepeating(['¬°Holaaa! ¬øC√≥mo te sientes hoy?','Hola, me alegra verte. ¬øC√≥mo vas hoy?']);
      case 'agradecimiento': return pickNonRepeating(['De nada, para eso estoy.','Siempre aqu√≠ para ayudarte.']);
      case 'ansiedad': return pickNonRepeating([`Respira conmigo: inhala 4s, sost√©n 4s, exhala 6s. ¬øLo intentamos juntos?`,`La ansiedad baja con grounding: mira 5 cosas, toca 4 objetos.`]);
      case 'depresion': return pickNonRepeating([`Siento que est√©s pasando por eso. ¬øPuedes decirme una cosa peque√±a que hiciste hoy?`,`Gracias por confiar. A veces rutinas peque√±as ayudan.`]);
      case 'insomnio': return pickNonRepeating([`Prueba higiene de sue√±o: sin pantallas 1h antes. ¬øA qu√© hora te acost√°s?`,`Si persiste, considera ayuda profesional. Te puedo ayudar a preparar la consulta.`]);
      case 'ejercicio': return pickNonRepeating([`Vamos a respirar 3 veces juntos: inhala... exhala... dime cuando termines.`]);
      case 'crisis': return pickNonRepeating([`Si sientes que puedes hacerte da√±o, por favor busca ayuda inmediata: llama a emergencias o a una l√≠nea de apoyo. En Colombia marca 123. ¬øQuieres que te muestre pasos concretos para pedir ayuda?`]);
      default:
        const docs = buildDocs(); const tf = computeTfIdf(docs); const best = findBestMatch(text, tf);
        if(best && best.score > 0.12){
          if(best.doc.id.startsWith('safe_')){ const cat = best.doc.id.replace('safe_',''); return pickNonRepeating(safeResponses[cat]); }
          return pickNonRepeating([best.doc.text]);
        }
        const mk = markovGenerate(text.split(' ')[0]?.toLowerCase(), 6);
        return pickNonRepeating([ `Gracias por contarme. ${randomChoice(variationPool)}`, `Lo siento que est√©s pasando por esto. ${mk?mk:''}` ]);
    }
  })();
  return coste√±oMode ? toCoste√±o(base) : base;
}

/* ---------- TTS ---------- */
function speakText(text){
  if(!voiceEnabled) return;
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const cleaned = text.replace(/\*\*|‚ö†Ô∏è/g,'').replace(/(?:https?:\/\/\S+)/g,'');
  const u = new SpeechSynthesisUtterance(cleaned);
  u.lang = coste√±oMode ? 'es-CO' : 'es-ES';
  u.rate = coste√±oMode ? 0.95 : 1;
  u.pitch = 1;
  const voices = window.speechSynthesis.getVoices();
  if(voices && voices.length){
    const prefer = voices.find(x=>/Google Espa√±ol|es-ES|es-CO|Spanish/i.test(x.name)) || voices[0];
    if(prefer) u.voice = prefer;
  }
  window.speechSynthesis.speak(u);
}
async function typeAndSpeak(text){
  const placeholder = document.createElement('div'); placeholder.className='typing'; placeholder.textContent='Escribiendo...';
  typingArea.appendChild(placeholder); messagesEl.scrollTop = messagesEl.scrollHeight;
  const thinking = Math.max(300, Math.min(1200, text.length * 6)) + Math.random()*300;
  await sleep(thinking);
  if(placeholder && placeholder.parentNode) placeholder.remove();
  const div = document.createElement('div'); div.className='bubble bot'; messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  for(let i=0;i<text.length;i++){ div.textContent = text.slice(0,i+1); messagesEl.scrollTop = messagesEl.scrollHeight; await sleep(6 + Math.random()*6); }
  lastBotMessage = text;
  pushConv('bot', text);
  speakText(text);
}

/* ---------- High risk tracking & resource dispatch ---------- */
function noteHighRiskOccurrence(){
  const now = Date.now();
  recentHighRiskTimestamps.push(now);
  recentHighRiskTimestamps = recentHighRiskTimestamps.filter(t => (now - t) <= HIGH_RISK_WINDOW_MS);
  if(!sentHelpLinkThisSession && recentHighRiskTimestamps.length >= HIGH_RISK_THRESHOLD){
    sendHelpResources();
    sentHelpLinkThisSession = true;
  }
}
function sendHelpResources(){
  resourceBox.style.display='block';
  resourceBox.innerHTML = `<strong>Recursos 24/7</strong><br/>He detectado se√±ales repetidas de riesgo. Opciones inmediatas:<ul style="margin:6px 0 0 18px">` +
    RESOURCE_24H_URLS.map(r=>`<li><a href="${r.url}" target="_blank" style="color:#dfffe0">${r.label}</a></li>`).join('') +
    `</ul><div style="margin-top:8px;font-size:13px">Enlace con l√≠neas internacionales: <a href="${PRIMARY_HELP_LINK}" target="_blank" style="color:#bfffb7">${PRIMARY_HELP_LINK}</a></div>` +
    `<div style="margin-top:8px"><button id="callBtn" class="btn" style="display:inline-block">Llamar ahora (106)</button> <button id="downloadLog" class="small" style="display:inline-block">Descargar log</button></div>`;
  // wire call button and download log
  setTimeout(()=>{ const callBtn=document.getElementById('callBtn'); if(callBtn) callBtn.addEventListener('click', ()=>{ window.location.href='tel:106'; }); const dl=document.getElementById('downloadLog'); if(dl) dl.addEventListener('click', ()=>{ window.open('/mnt/data/conversacion_saludmental.json', '_blank'); }); }, 200);
  const botText = coste√±oMode ? "He detectao se√±ales repetidas, mi llave. Te dejo opciones pa' que busques ayuda ya mismo." : "He detectado se√±ales repetidas de riesgo. Te env√≠o opciones de ayuda 24h y contactos. Si est√°s en peligro ahora, por favor llama a emergencias.";
  typeAndSpeak(botText);
  crisisMode = true;
}

/* ---------- Conversation persistence ---------- */
function pushConv(who,text){ const conv = loadConv(); conv.push({who,text,at:Date.now()}); saveConv(conv); }
function getContext(){ const conv = loadConv().slice(-300); return conv.filter(c=>c.who==='user').map(u=>u.text).slice(-30); }

/* ---------- Respond pipeline ---------- */
async function respondTo(userText){
  if(!userText||!userText.trim()) return;
  const lowered = userText.toLowerCase();
  const isHigh = crisisKeywords.some(k => lowered.includes(k));
  // Never echo user text as bot response
  if(isHigh){
    noteHighRiskOccurrence();
    const crisisReply = coste√±oMode
      ? "Parcero, eso me preocupa mucho. Si est√°s en peligro ahora, al√©jate de cualquier borde o cosa peligrosa y llama a emergencias. ¬øEst√°s con alguien ahora?"
      : "Me preocupa mucho lo que est√°s diciendo. Si est√°s en peligro ahora, al√©jate de cualquier lugar inseguro y llama a emergencias. ¬øEst√°s con alguien ahora?";
    await typeAndSpeak(crisisReply);
    crisisMode = true;
    if(autoOpenOnCrisis.checked) openDrawer();
    return;
  }

  if(crisisMode){
    // stay in crisis mode, ask for safety info, don't switch to casual responses
    const safeReply = coste√±oMode ? "Toy pendiente, contame si est√°s con alguien o si ya pod√©s moverte a un sitio seguro." : "Sigo aqu√≠ contigo. ¬øEst√°s con alguien o en un lugar seguro ahora?";
    await typeAndSpeak(safeReply);
    return;
  }

  // teach command: 'responde X => Y'
  const teach = parseTeach(userText);
  if(teach){ const db = loadCustom(); db[teach.key] = teach.value; saveCustom(db); const ack = coste√±oMode ? `Listo, aprend√≠: cuando vea "${teach.key}" dir√© "${teach.value}"` : `Listo, aprend√≠: cuando vea "${teach.key}" responder√©: "${teach.value}"`; await typeAndSpeak(ack); return; }

  // normal flow
  const intent = classifyIntent(userText);
  const ctx = getContext();
  const resp = responseByIntent(intent, userText, ctx);
  await typeAndSpeak(resp);
  markovTrain(userText);
}

/* ---------- teach parser ---------- */
function parseTeach(text){
  const rx = /responde\s+(.+?)\s*=>\s*(.+)/i;
  const m = text.match(rx);
  if(m) return { key: m[1].trim().toLowerCase(), value: m[2].trim() };
  return null;
}

/* ---------- UI helpers ---------- */
function appendUser(text){ const d=document.createElement('div'); d.className='bubble user'; d.textContent=text; messagesEl.appendChild(d); messagesEl.scrollTop = messagesEl.scrollHeight; pushConv('user', text); }

/* ---------- Events ---------- */
/* Open chat from FAB (oval) */
openFab.addEventListener('click', ()=>{ scrollToTopAndFocus(); loadConversation(); if(showAvatarToggle.checked) animateAvatarEntrance(); });

function scrollToTopAndFocus(){ window.scrollTo({ top: 0, behavior: 'smooth' }); inputEl.focus(); }
function animateAvatarEntrance(){ /* drawer shows avatar on open; small visual effect (no heavy animation needed) */ }

/* Drawer open/hide */
menuBtnTop.addEventListener('click', ()=>{ drawer.classList.toggle('open'); drawer.setAttribute('aria-hidden', !drawer.classList.contains('open')); });
function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden', 'false'); }
function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden', 'true'); }

/* Send message */
sendBtn.addEventListener('click', async ()=>{ const t=inputEl.value.trim(); if(!t) return; inputEl.value=''; appendUser(t); await respondTo(t); });
inputEl.addEventListener('keydown', async e=>{ if(e.key==='Enter'){ e.preventDefault(); const t = inputEl.value.trim(); if(!t) return; inputEl.value=''; appendUser(t); await respondTo(t); } });

/* voice/mic */
voiceToggle.addEventListener('click', ()=>{ voiceEnabled = !voiceEnabled; voiceToggle.textContent = voiceEnabled ? 'üîä' : 'üîà'; if(!voiceEnabled) window.speechSynthesis.cancel(); });

if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang = 'es-CO';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onresult = async (e)=>{ const text = e.results[0][0].transcript; appendUser(text); await respondTo(text); };
  recognition.onend = ()=>{ listening=false; micBtn.textContent='üé§'; };
  recognition.onerror = ()=>{ listening=false; micBtn.textContent='üé§'; };
  micBtn.addEventListener('click', ()=>{ if(listening){ recognition.stop(); listening=false; micBtn.textContent='üé§'; } else { recognition.start(); listening=true; micBtn.textContent='‚èπ'; } });
} else {
  micBtn.addEventListener('click', ()=>{ alert('Reconocimiento de voz no soportado en este navegador. Usa Chrome/Edge con permisos de micr√≥fono.'); });
}

/* Drawer controls */
costenoToggle.addEventListener('change', (e)=>{ coste√±oMode = e.target.checked; coste√±oBadge.style.display = coste√±oMode ? 'inline-block' : 'none'; });
showAvatarToggle.addEventListener('change', (e)=>{ showAvatarOnOpen = e.target.checked; });
autoOpenOnCrisis.addEventListener('change', (e)=>{ /* toggles auto-open behavior */ });

exerciseBtn.addEventListener('click', async ()=>{ const ex = coste√±oMode ? "Respir√† suave: inhala 4, sosten√© 4 y exhal√° 6, mi llave." : "Vamos a respirar: inhala 4s, sost√©n 4s, exhala 6s."; await typeAndSpeak(ex); });
contactBtn.addEventListener('click', ()=>{ alert('Funcionalidad: solicitar contacto. Integra backend para notificar a un profesional.'); });

/* Conversation load/save */
function loadConversation(){ messagesEl.innerHTML=''; const conv = loadConv(); for(const item of conv){ const d = document.createElement('div'); d.className = 'bubble ' + (item.who==='user' ? 'user' : 'bot'); d.textContent = item.text; messagesEl.appendChild(d); } messagesEl.scrollTop = messagesEl.scrollHeight; if(conv.length===0){ const welcome = coste√±oMode ? "Hola, mi llave. Soy tu asistente. Si est√°s en riesgo busca ayuda inmediata." : "Hola ‚Äî soy tu asistente de apoyo. Si est√°s en riesgo, busca ayuda inmediata."; typeAndSpeak(welcome); pushConv('bot', welcome); } }

/* Init */
(function init(){
  // default toggles
  coste√±oMode = false;
  showAvatarOnOpen = true;
  autoOpenOnCrisis.checked = true;
  loadConversation();
  // ensure fab visible
  openFab.style.display = 'flex';
})();
</script>

</body>
</html>